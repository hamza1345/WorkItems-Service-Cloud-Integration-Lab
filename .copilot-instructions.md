# Instructions Copilot - Développement Salesforce Apex

## Projet
- Version API : 65.0
- Repository : github.com/hamza1345/WorkItems-Service-Cloud-Integration-Lab
- Branche : develop

---

## 19 Standards à Respecter

### Partage & Sécurité
1. Déclarer le sharing : `public with sharing` (données) ou `public without sharing` (utilitaires)
2. Valider CRUD : `sObjectType.getDescribe(SObjectDescribeOptions.DEFERRED).isAccessible()`
3. Utiliser DEFERRED pour lazy-loading des describes

### Boucles & Performance
4. Pas de SOQL dans les boucles → Bulkifier avec l'opérateur `IN` (limite 100)
5. Pas de DML dans les boucles → DML après la boucle (limite 150)
6. Pas d'IDs en dur → Utiliser CustomMetadata

### Qualité du Code
7. Centraliser SOQL/DML dans les méthodes `@TestVisible`
8. Pas de `System.debug()` en production
9. Constantes pour les nombres magiques : `private static final`
10. Noms clairs : `customerName` pas `a` ou `x`

### Sécurité
11. Fallbacks sûrs pour données null
12. Try-catch autour de SOQL/DML
13. `@TestVisible` sur les méthodes test-only
14. Cacher les opérations coûteuses
15. Ajouter `@description` sur chaque méthode

### Documentation
16. Supprimer le code inutilisé
17. Pas d'espaces en fin de ligne
18. Couverture minimale 80%+ de tests
19. `@SuppressWarnings` uniquement si justifié

---

## Checklist Rapide

- [ ] Modèle de sharing déclaré
- [ ] CRUD validé
- [ ] Pas de boucles avec SOQL/DML
- [ ] Pas d'IDs en dur
- [ ] Try-catch sur les opérations BD
- [ ] Pas de System.debug()
- [ ] Constantes au lieu de nombres magiques
- [ ] Noms de variables clairs
- [ ] @TestVisible sur les méthodes internes
- [ ] @description sur les méthodes
- [ ] Gestion sûre des null
- [ ] Pas d'espaces en fin de ligne
- [ ] Couverture 80%+
- [ ] Scanner ok : `sf scanner:run`

---

## Limites de Gouvernance

| Limite | Max | Solution |
|--------|-----|----------|
| Requêtes SOQL | 100 | Bulkifier avec `IN` |
| Déclarations DML | 150 | DML après boucle |
| Temps CPU | 10s | Optimiser boucles |
| Heap size | 6 MB | Cacher résultats |

---

## Patterns de Code

### Validation CRUD
```apex
SObjectType sObjectType = Account.sObjectType;
if (!sObjectType.getDescribe(SObjectDescribeOptions.DEFERRED).isAccessible()) {
    return new List<Account>();
}
List<Account> accounts = [SELECT Id, Name FROM Account];
```

### Bulkifier SOQL
```apex
Set<Id> accountIds = new Set<Id>();
for (Account acc : accounts) {
    accountIds.add(acc.Id);
}
List<Contact> contacts = [SELECT Id, AccountId FROM Contact WHERE AccountId IN :accountIds];
```

### Bulkifier DML
```apex
for (Opportunity opp : opportunities) {
    opp.StageName = 'Closed Won';
}
update opportunities;
```

### Fallbacks Sûrs
```apex
try {
    result = queryData();
} catch (Exception e) {
    result = getDefaultData();
}
```

### Pattern de Caching
```apex
@TestVisible
private static MyConfig__mdt cached;
@TestVisible
private static Boolean initialized = false;

private static void init() {
    if (initialized) return;
    cached = [SELECT ... LIMIT 1];
    initialized = true;
}
```

### Template de Classe
```apex
/**
 * @description Objectif de la classe.
 */
public with sharing class MyClass {
    private static final String DEFAULT = 'valeur';
    
    /**
     * @description Objectif de la méthode.
     * @return Type du résultat
     */
    public static String myMethod() {
        try {
            return '';
        } catch (Exception e) {
            return null;
        }
    }
}
```

### Template de Test
```apex
@IsTest
private class MyClassTest {
    
    @IsTest
    static void testCasHeureux() {
        // Arrange
        
        // Act
        
        // Assert
        Assert.isTrue(true);
    }
}
```

---

## Commandes

| Tâche | Commande |
|-------|----------|
| Analyser | `sf scanner:run --target force-app/` |
| Tester | `npm run test:unit` |
| Déployer | `sf project deploy start -d force-app/main/default/` |
| Récupérer | `sf project retrieve start -m CustomObject` |

---

## Fichiers de Référence

- `PMD_BEST_PRACTICES.md` - Règles détaillées
- `CODE_REVIEW_CHECKLIST.md` - Directives de review
- `FeatureFlags.cls` - Exemple d'implémentation
- `QUICK_START.md` - Guide de démarrage
